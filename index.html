<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VUMC Kids Check-In</title>

  <!-- DYMO Label Framework (kiosk PC must have DYMO Web Service running) -->
  <script src="https://labelwriter.com/software/dls/sdk/js/DYMO.Label.Framework.js"></script>
  <!-- QRCode.js for QR generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* --- Dark theme (mobile-responsive) --- */
    :root { --bg:#0b1728; --card:#0f1e34; --muted:#a8bade; --text:#eaf2ff; --accent:#6fb2ff; --line:rgba(255,255,255,0.08); }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font:16px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg,#0b1728,#0a1422); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:rgba(255,255,255,0.03); border-bottom:1px solid var(--line); position:sticky; top:0; backdrop-filter: blur(6px); z-index:5; }
    header h1 { margin:0; font-size:18px; letter-spacing:0.3px; }
    .container { max-width:1100px; margin:16px auto; padding:0 12px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.25); overflow:clip; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; padding:12px; align-items:center; border-bottom:1px solid var(--line); }
    .toolbar h2 { margin:0 8px 0 0; font-size:16px; font-weight:600; color:#cfe1ff; }
    .toolbar .sep { flex:1; }
    .toolbar input, .toolbar select, .toolbar button { background:#0c1730; color:var(--text); border:1px solid rgba(255,255,255,0.14); border-radius:10px; padding:10px 12px; font-size:15px; }
    .toolbar button { background: linear-gradient(180deg,#1976ff,#0f63da); border:none; font-weight:700; letter-spacing:0.2px; cursor:pointer; }
    .toolbar button:disabled { opacity:.5; cursor:not-allowed; }
    .flex { display:flex; gap:16px; }
    .left, .right { padding:16px; }
    .left { flex: 1 1 640px; min-width:0; }
    .right { width:360px; background:#0c1730; border-left:1px solid var(--line); }
    .list { max-height:64vh; overflow:auto; border:1px solid var(--line); border-radius:12px; }
    .kid { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid var(--line); }
    .kid:last-child { border-bottom:none; }
    .kid .meta { color:var(--muted); font-size:12px; margin-top:4px; }
    .kid button { padding:12px 12px; border:none; border-radius:10px; background:#1a7cff; color:white; font-weight:700; cursor:pointer; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(111,178,255,.16); color:#cfe1ff; border:1px solid rgba(111,178,255,.35); font-size:12px; }
    .muted { color:var(--muted); font-size:12px; }
    .hint { margin-top:8px; color:#a8bade; font-size:13px; }
    footer { text-align:center; padding:18px; color:#98abc8; font-size:12px; }
    .ok { color:#73ffcd; }
    .warn { color:#ffd166; }
    .err { color:#ff8aa0; }
    #qrPreview { background:#fff; border-radius:8px; padding:8px; width:100%; height:180px; display:flex; align-items:center; justify-content:center }

    /* Modal styles */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal.open { display: flex; }
    .dialog { width: 640px; max-width: 96vw; background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); color:var(--text); }
    .dialog h3 { margin: 6px 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid .full { grid-column: 1 / -1; }
    .dialog input, .dialog select { width: 100%; background:#0c1730; color:var(--text); border:1px solid rgba(255,255,255,0.14); border-radius:10px; padding:12px 14px; font-size:16px; }
    .dialog .row { display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
    .btn { padding:12px 16px; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.primary { background: linear-gradient(180deg,#1976ff,#0f63da); color:#fff; }
    .btn.ghost { background: transparent; color: var(--text); border:1px solid rgba(255,255,255,0.18); }
    video { width:100%; border:1px solid var(--line); border-radius:12px; }

    /* --- Mobile adjustments --- */
    @media (max-width: 820px) {
      header h1 { font-size:16px; }
      .toolbar { gap:8px; }
      .toolbar input, .toolbar select, .toolbar button { font-size:16px; padding:12px 14px; }
      .toolbar .sep { display:none; }
      .flex { flex-direction: column; }
      .right { width:100%; border-left:none; border-top:1px solid var(--line); }
      .list { max-height: 54vh; }
      .kid { gap:8px; }
      .kid button { width: 42%; min-width: 150px; }
      .dialog { width: 96vw; }
      .grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 420px) {
      .kid button { width: 100%; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar > * { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>VUMC Kids Check-In</h1>
    <div class="pill" id="printerStatus">Printer: <span class="muted">checking…</span></div>
  </header>

  <div class="container">
    <div class="card">
      <div class="toolbar">
        <h2>Staff Sign-In</h2>
        <input id="pin" type="password" placeholder="Staff PIN" autocomplete="one-time-code" />
        <select id="service">
          <option>9:30 AM</option>
          <option>10:30 AM</option>
        </select>
        <span class="sep"></span>
        <input id="search" type="search" placeholder="Search child name…" />
        <select id="group">
          <option value="">All Groups</option>
          <option>Nursery</option>
          <option>Pre-K</option>
          <option>Kids Church</option>
        </select>
        <button id="signInBtn" type="button">Unlock</button>
        <button id="guestBtn" class="btn primary" disabled>Guest Check-In</button>
        <button id="photoBtn" class="btn ghost" disabled>Take Photo</button>
      </div>

      <div class="flex">
        <div class="left">
          <div class="hint">Filter the roster, then press <b>Check-In & Print</b>. Two labels print: child tag + parent claim.</div>
          <div class="list" id="list"></div>
        </div>
        <aside class="right">
          <h3>Print Preview (QR)</h3>
          <div id="qrPreview"></div>
          <div class="muted" style="margin-top:6px">Preview shows the last QR generated; the DYMO label prints this QR PNG.</div>
          <hr style="border-color:var(--line); margin:16px 0" />
          <div class="muted">Signed-in: <span id="signed" class="warn">locked</span></div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Guest Check-In Modal -->
  <div class="modal" id="guestModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-labelledby="guestTitle">
      <h3 id="guestTitle">Quick Guest Check-In</h3>
      <div class="grid">
        <input id="g_parent_first" placeholder="Parent First (optional)" />
        <input id="g_parent_last" placeholder="Parent Last (optional)" />
        <input id="g_child_first" placeholder="Child First *" />
        <input id="g_child_last" placeholder="Child Last (optional)" />
        <select id="g_group" class="full">
          <option>Nursery</option>
          <option>Pre-K</option>
          <option>Kids Church</option>
        </select>
        <input id="g_allergies" class="full" placeholder="Allergies / Notes (optional)" />
        <input id="g_phone" class="full" placeholder="Parent Mobile (required for pickup)" required />
      </div>
      <div class="row">
        <button class="btn ghost" id="g_cancel" type="button">Cancel</button>
        <button class="btn primary" id="g_submit" type="button">Print Guest Label</button>
      </div>
      <div class="muted hint">* Minimum required: Child First name and Parent Mobile. Uses the selected Service from the toolbar.</div>
    </div>
  </div>

  <!-- Photo Capture Modal -->
  <div class="modal" id="photoModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-labelledby="photoTitle">
      <h3 id="photoTitle">Photo Capture</h3>
      <video id="cam" autoplay playsinline></video>
      <div class="row">
        <button class="btn ghost" id="snapChild" type="button">Save Child</button>
        <button class="btn ghost" id="snapAdult" type="button">Save Adult</button>
        <button class="btn primary" id="closePhoto" type="button">Done</button>
      </div>
      <div class="muted hint">Photos are used only for pickup verification and retained per church policy.</div>
    </div>
  </div>

  <footer>
    © <span id="yr"></span> Versailles UMC · Kids & Family Ministries
  </footer>

  <script>
  // ─── CONFIG ────────────────────────────────────────────────────────────────
  const REQUIRED_PIN = "2301"; // Staff PIN
  const STATIC_ROSTER_URL = "./roster.json"; // optional static roster file
  // const APPS_SCRIPT_ROSTER_URL = "https://script.google.com/macros/s/XXXXXXXX/exec?action=roster";
  // const APPS_SCRIPT_LOG_URL    = "https://script.google.com/macros/s/XXXXXXXX/exec?action=log";
  // Optional SMS webhook (Apps Script/Twilio). If set, app will POST { phone, text, png }
  const SMS_API_URL = ""; // e.g., https://script.google.com/macros/s/XXX/exec
  // Optional Photo upload webhook (Apps Script). If set, app will POST { child_id, typ, png }
  const PHOTOS_API_URL = ""; // e.g., https://script.google.com/macros/s/YYY/exec

  const DYMO_LABEL_NAME = "DYMO LabelWriter 450 Turbo";

  // ─── HELPERS & STATE ───────────────────────────────────────────────────────
  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  el('#yr').textContent = new Date().getFullYear();

  function pickupCode() { return String(Math.floor(100000 + Math.random() * 900000)); }
  function ageFromDOB(dob) { if (!dob) return null; const d = new Date(dob); if (isNaN(d)) return null; const diff = Date.now() - d.getTime(); return Math.floor(diff / (365.25*24*60*60*1000)); }
  function groupFor(child) { if (child.default_group) return child.default_group; const a = ageFromDOB(child.dob); if (a == null) return "Kids Church"; if (a < 3) return "Nursery"; if (a < 5) return "Pre-K"; return "Kids Church"; }
  function nameOf(k) { return `${k.first_name||''} ${k.last_name||''}`.trim(); }

  let printers = []; let roster = []; let unlocked = false; let currentKid = null; let camStream = null;

  // DYMO label template (address label w/ QR image object)
  const LABEL_XML = `
<DieCutLabel Version="8.0" Units="twips">
  <PaperOrientation>Landscape</PaperOrientation>
  <Id>Address</Id>
  <PaperName>30252 Address</PaperName>
  <DrawCommands/>
  <ObjectInfo>
    <TextObject>
      <Name>ChildName</Name>
      <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
      <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
      <Font Family="Arial" Size="12" Bold="True"/>
      <Text>CHILD NAME</Text>
    </TextObject>
    <Bounds X="180" Y="40" Width="3000" Height="500"/>
  </ObjectInfo>
  <ObjectInfo>
    <TextObject>
      <Name>GroupLine</Name>
      <Font Family="Arial" Size="9" Bold="False"/>
      <Text>GROUP / SERVICE</Text>
    </TextObject>
    <Bounds X="180" Y="570" Width="3000" Height="350"/>
  </ObjectInfo>
  <ObjectInfo>
    <ImageObject>
      <Name>QRImg</Name>
      <Image>iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAA=</Image>
    </ImageObject>
    <Bounds X="180" Y="820" Width="3000" Height="1100"/>
  </ObjectInfo>
</DieCutLabel>`;

  // ─── DYMO INIT & PRINT ─────────────────────────────────────────────────────
  async function initDymo() {
    const status = el('#printerStatus');
    try {
      const ps = await dymo.label.framework.getPrintersAsync();
      printers = ps || [];
      if (!printers.length) { status.innerHTML = 'Printer: <span class="err">not found</span>'; }
      else {
        const p = printers.find(p => p.isConnected && (!DYMO_LABEL_NAME || p.name === DYMO_LABEL_NAME)) || printers[0];
        status.innerHTML = `Printer: <span class="ok">${p.name}</span>`;
      }
    } catch (e) { status.innerHTML = 'Printer: <span class="err">DYMO service unavailable</span>'; console.error(e); }
  }

  async function printDymoLabels(kid, code, service, qrPngDataURL) {
    const p = printers.find(p => p.isConnected && (!DYMO_LABEL_NAME || p.name === DYMO_LABEL_NAME)) || printers[0];
    if (!p) throw new Error('No DYMO printer detected');
    const line = `${groupFor(kid)} • ${service} • Code: ${code}`;
    let label = dymo.label.framework.openLabelXml(LABEL_XML);
    label.setObjectText("ChildName", nameOf(kid));
    label.setObjectText("GroupLine", line);
    label.setObjectImage("QRImg", qrPngDataURL);
    label.print(p.name);
    let claim = dymo.label.framework.openLabelXml(LABEL_XML);
    claim.setObjectText("ChildName", `Pickup: ${nameOf(kid)}`);
    claim.setObjectText("GroupLine", `Code: ${code}`);
    claim.setObjectImage("QRImg", qrPngDataURL);
    claim.print(p.name);
  }

  // ─── ROSTER LOAD & LOGGING ────────────────────────────────────────────────
  async function loadRoster() {
    if (typeof APPS_SCRIPT_ROSTER_URL === 'string') {
      try { const r = await fetch(APPS_SCRIPT_ROSTER_URL, {cache:'no-store'}); const j = await r.json(); roster = (j.data||[]).map(x => ({...x, _group: groupFor(x)})); return; }
      catch (e) { console.warn('Apps Script roster failed, falling back to static', e); }
    }
    try { const res = await fetch(STATIC_ROSTER_URL, {cache:'no-store'}); roster = (await res.json()).map(x => ({...x, _group: groupFor(x)})); }
    catch { roster = []; }
  }

  function logCheck(actionType, service, kid, code) {
    if (typeof APPS_SCRIPT_LOG_URL !== 'string') return;
    const params = new URLSearchParams({ actionType, service, child_id: kid.child_id||'', pickup_code: code, by:'STAFF' });
    fetch(APPS_SCRIPT_LOG_URL + '&' + params.toString(), {cache:'no-store'}).catch(()=>{});
  }

  // ─── QR GEN ───────────────────────────────────────────────────────────────
  async function generateQrPng(payload) {
    const wrap = document.createElement('div');
    new QRCode(wrap, { text: payload, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.M });
    await new Promise(r => setTimeout(r, 50));
    const canvas = wrap.querySelector('canvas');
    if (!canvas) throw new Error('QR render failed');
    const prev = el('#qrPreview'); prev.innerHTML = ''; prev.appendChild(canvas.cloneNode(true));
    return canvas.toDataURL('image/png');
  }

  // ─── UI RENDER ────────────────────────────────────────────────────────────
  function renderList() {
    const q = el('#search').value.trim().toLowerCase();
    const g = el('#group').value; const box = el('#list'); box.innerHTML = '';
    roster
      .filter(k => !q || nameOf(k).toLowerCase().includes(q))
      .filter(k => !g || k._group === g)
      .sort((a,b) => (a.last_name||'').localeCompare(b.last_name||''))
      .forEach(kid => {
        const row = document.createElement('div'); row.className = 'kid';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${nameOf(kid)}</strong></div>
                          <div class="meta">${kid._group}${kid.allergies ? ' • Allergy: '+kid.allergies : ''}</div>`;
        const btn = document.createElement('button'); btn.textContent = 'Check-In & Print'; btn.onclick = () => checkIn(kid); btn.disabled = !unlocked;
        row.append(left, btn); box.appendChild(row);
      });
  }

  function ensureUnlocked() { if (!unlocked) { alert('Enter the Staff PIN to unlock.'); return false; } return true; }

  // ─── CHECK-IN ─────────────────────────────────────────────────────────────
  async function checkIn(kid) {
    if (!ensureUnlocked()) return;
    currentKid = kid;
    const service = el('#service').value; const code = pickupCode();
    const payload = JSON.stringify({ v:1, child_id: kid.child_id||'', code, service, ts: Date.now() });
    const qrPng = await generateQrPng(payload);
    try {
      await printDymoLabels(kid, code, service, qrPng);
      logCheck('checkin', service, kid, code);
      if (SMS_API_URL) {
        const want = confirm('Text this QR to parent?');
        if (want) { const phone = prompt('Enter mobile number (+1…)'); if (phone) sendSms(phone, `Pickup code: ${code} for ${nameOf(kid)} (${groupFor(kid)} @ ${service})`, qrPng); }
      }
      alert(`Checked in ${nameOf(kid)}\nPickup code: ${code}`);
    } catch(e) { console.error(e); alert('Printing failed. Is DYMO Web Service running?'); }
  }

  // ─── EVENTS ───────────────────────────────────────────────────────────────
  // Unlock
  el('#signInBtn').addEventListener('click', () => {
    const pin = (el('#pin').value || '').trim();
    if (!pin) return alert('Enter PIN');
    if (pin !== REQUIRED_PIN) return alert('Invalid PIN');
    unlocked = true; el('#signed').textContent = 'unlocked'; el('#signed').className = 'ok';
    els('.kid button').forEach(b => b.disabled = false); el('#guestBtn').disabled = false; el('#photoBtn').disabled = false;
  });
  el('#pin').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') el('#signInBtn').click(); });

  // Filters
  el('#search').addEventListener('input', renderList);
  el('#group').addEventListener('change', renderList);

  // Guest modal
  el('#guestBtn').addEventListener('click', () => { if (!unlocked) return alert('Enter the Staff PIN to unlock.'); el('#guestModal').classList.add('open'); });
  el('#g_cancel').addEventListener('click', () => el('#guestModal').classList.remove('open'));
  el('#g_submit').addEventListener('click', async () => {
    if (!unlocked) return alert('Enter the Staff PIN to unlock.');
    const childFirst = el('#g_child_first').value.trim();
    const childLast  = el('#g_child_last').value.trim();
    const allergies  = el('#g_allergies').value.trim();
    const groupSel   = el('#g_group').value;
    const phone      = el('#g_phone').value.trim();
    if (!childFirst) return alert('Child first name is required.');
    if (!phone) return alert('Parent mobile is required.');
    const kid = { child_id: 'G' + Date.now(), first_name: childFirst, last_name: childLast, allergies: allergies, default_group: groupSel };
    roster.unshift({...kid, _group: groupSel}); renderList(); currentKid = kid;
    const service = el('#service').value; const code = pickupCode();
    const payload = JSON.stringify({ v:1, child_id: kid.child_id, code, service, ts: Date.now(), guest: true });
    try {
      const qrPng = await generateQrPng(payload);
      await printDymoLabels(kid, code, service, qrPng);
      logCheck('guest_checkin', service, kid, code);
      if (SMS_API_URL) { sendSms(phone, `Pickup code: ${code} for ${nameOf(kid)} (${groupFor(kid)} @ ${service})`, qrPng); }
      alert(`Guest checked in: ${nameOf(kid)}\nPickup code: ${code}`);
    } catch(e) {
      console.error(e);
      alert('Printing failed. Is DYMO Web Service running?');
    } finally {
      // Always close and clear so the line keeps moving
      el('#guestModal').classList.remove('open');
      ['#g_parent_first','#g_parent_last','#g_child_first','#g_child_last','#g_allergies','#g_phone'].forEach(s=>{ const f = el(s); if (f) f.value=''; });
    }
  });

  // Photo modal
  el('#photoBtn').addEventListener('click', async () => {
    if (!unlocked) return alert('Enter Staff PIN first.');
    if (!currentKid) return alert('Select or check-in a child first.');
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
    if (!isSecure) { alert('Camera requires HTTPS (or localhost). Open this page via https:// to use the camera.'); return; }
    el('#photoModal').classList.add('open');
    try {
      // Try rear camera first; fall back to any camera
      let constraints = { video: { facingMode: { ideal: 'environment' } } };
      try { camStream = await navigator.mediaDevices.getUserMedia(constraints); }
      catch { constraints = { video: true }; camStream = await navigator.mediaDevices.getUserMedia(constraints); }
      const v = el('#cam'); v.srcObject = camStream; await v.play();
    } catch (e) {
      console.error(e);
      alert('Camera not available or permission denied. Check browser permissions and HTTPS.');
      el('#photoModal').classList.remove('open');
    }
  });
  el('#closePhoto').addEventListener('click', () => { el('#photoModal').classList.remove('open'); if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; } });
  el('#snapChild').addEventListener('click', () => captureAndSave('child'));
  el('#snapAdult').addEventListener('click', () => captureAndSave('adult'));

  async function captureAndSave(kind) {
    if (!PHOTOS_API_URL) return alert('Photo API not configured.');
    const video = el('#cam');
    const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const png = canvas.toDataURL('image/png');
    try {
      const r = await fetch(PHOTOS_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ child_id: currentKid.child_id || ('G'+Date.now()), typ: kind, png }) });
      const j = await r.json(); if (j.ok) alert(`${kind === 'child' ? 'Child' : 'Adult'} photo saved.`); else alert('Save failed.');
    } catch { alert('Save failed.'); }
  }

  // INIT
  (async () => { await initDymo(); await loadRoster(); renderList(); })();

  // SMS helper
  async function sendSms(phone, text, pngDataUrl) {
    try { const res = await fetch(SMS_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, text, png: pngDataUrl }) }); if (!res.ok) throw new Error('SMS send failed'); }
    catch(e) { console.warn('SMS error', e); }
  }

  // Close modals with ESC
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') {
      const gm = document.getElementById('guestModal'); if (gm && gm.classList.contains('open')) gm.classList.remove('open');
      const pm = document.getElementById('photoModal'); if (pm && pm.classList.contains('open')) pm.classList.remove('open');
    }
  });
  </script>
</body>
</html>
