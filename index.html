<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VUMC Kids Check‑In</title>
  <script src="https://labelwriter.com/software/dls/sdk/js/DYMO.Label.Framework.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --bg:#0b1728; --card:#0f1e34; --muted:#a8bade; --text:#eaf2ff; --accent:#6fb2ff; --line:rgba(255,255,255,0.08); }
    * { box-sizing: border-box; }
    body { margin:0; font:16px system-ui, sans-serif; background: linear-gradient(180deg,#0b1728,#0a1422); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:rgba(255,255,255,0.03); border-bottom:1px solid var(--line); }
    header h1 { margin:0; font-size:18px; }
    .container { max-width:1100px; margin:16px auto; padding:0 12px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.25); }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; padding:12px; align-items:center; border-bottom:1px solid var(--line); }
    .toolbar h2 { margin:0 8px 0 0; font-size:16px; font-weight:600; color:#cfe1ff; }
    .toolbar input, .toolbar select, .toolbar button { background:#0c1730; color:var(--text); border:1px solid rgba(255,255,255,0.14); border-radius:10px; padding:10px 12px; font-size:15px; }
    .toolbar button { background: linear-gradient(180deg,#1976ff,#0f63da); border:none; font-weight:700; cursor:pointer; }
    .flex { display:flex; gap:16px; }
    .left, .right { padding:16px; }
    .left { flex: 1 1 640px; }
    .right { width:360px; background:#0c1730; border-left:1px solid var(--line); }
    .list { max-height:64vh; overflow:auto; border:1px solid var(--line); border-radius:12px; }
    .kid { display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid var(--line); }
    .kid .meta { color:var(--muted); font-size:12px; }
    .kid button { padding:12px; border:none; border-radius:10px; background:#1a7cff; color:white; font-weight:700; cursor:pointer; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; }
    .modal.open { display: flex; }
    .dialog { width: 640px; max-width: 96vw; background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; color:var(--text); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid .full { grid-column: 1 / -1; }
    .dialog input, .dialog select { width: 100%; background:#0c1730; color:var(--text); border:1px solid rgba(255,255,255,0.14); border-radius:10px; padding:12px 14px; font-size:16px; }
    .dialog .row { display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
    .btn { padding:12px 16px; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.primary { background: linear-gradient(180deg,#1976ff,#0f63da); color:#fff; }
    .btn.ghost { background: transparent; color: var(--text); border:1px solid rgba(255,255,255,0.18); }
    video { width:100%; border:1px solid var(--line); border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <h1>VUMC Kids Check‑In</h1>
    <div id="printerStatus">Printer: <span class="muted">checking…</span></div>
  </header>

  <div class="container">
    <div class="card">
      <div class="toolbar">
        <h2>Staff Sign‑In</h2>
        <input id="pin" type="password" placeholder="Staff PIN" />
        <button id="signInBtn" type="button">Unlock</button>
        <button id="guestBtn" class="btn primary" disabled>Guest Check‑In</button>
        <button id="photoBtn" class="btn ghost" disabled>Take Photo</button>
      </div>
      <div class="flex">
        <div class="left">
          <div class="list" id="list"></div>
        </div>
        <aside class="right">
          <h3>Print Preview (QR)</h3>
          <div id="qrPreview"></div>
          <div id="signed">locked</div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Guest Modal -->
  <div class="modal" id="guestModal">
    <div class="dialog">
      <h3>Quick Guest Check‑In</h3>
      <div class="grid">
        <input id="g_parent_first" placeholder="Parent First (optional)" />
        <input id="g_parent_last" placeholder="Parent Last (optional)" />
        <input id="g_child_first" placeholder="Child First *" />
        <input id="g_child_last" placeholder="Child Last (optional)" />
        <select id="g_group" class="full"><option>Nursery</option><option>Pre‑K</option><option>Kids Church</option></select>
        <input id="g_allergies" class="full" placeholder="Allergies / Notes (optional)" />
        <input id="g_phone" class="full" placeholder="Parent Mobile (required)" required />
      </div>
      <div class="row">
        <button class="btn ghost" id="g_cancel" type="button">Cancel</button>
        <button class="btn primary" id="g_submit" type="button">Print Guest Label</button>
      </div>
    </div>
  </div>

  <!-- Photo Modal -->
  <div class="modal" id="photoModal">
    <div class="dialog">
      <h3>Photo Capture</h3>
      <video id="cam" autoplay playsinline></video>
      <div class="row">
        <button class="btn ghost" id="snapChild" type="button">Save Child</button>
        <button class="btn ghost" id="snapAdult" type="button">Save Adult</button>
        <button class="btn primary" id="closePhoto" type="button">Done</button>
      </div>
    </div>
  </div>

  <script>
    const REQUIRED_PIN = "2301";
    const el = sel => document.querySelector(sel);
    let unlocked = false, camStream = null;

    // Unlock logic
    document.addEventListener('DOMContentLoaded', ()=>{
      console.log('App loaded. REQUIRED_PIN =', REQUIRED_PIN);
      el('#signInBtn').addEventListener('click', ()=>{
        const pin = el('#pin').value.trim();
        if (!pin) return alert('Enter PIN');
        if (pin !== REQUIRED_PIN) return alert('Invalid PIN');
        unlocked = true;
        el('#signed').textContent = 'unlocked';
        el('#signed').className = 'ok';
        el('#guestBtn').disabled=false;
        el('#photoBtn').disabled=false;
        alert('Station unlocked.');
      });
      el('#pin').addEventListener('keydown',(e)=>{if(e.key==='Enter')el('#signInBtn').click();});
    });

    // Guest modal
    el('#guestBtn').addEventListener('click',()=>{if(unlocked) el('#guestModal').classList.add('open');});
    el('#g_cancel').addEventListener('click',()=>el('#guestModal').classList.remove('open'));
    el('#g_submit').addEventListener('click',()=>{el('#guestModal').classList.remove('open');alert('Guest checked in');});

    // Photo modal
    el('#photoBtn').addEventListener('click', async ()=>{
      if(!unlocked)return alert('Unlock first.');
      el('#photoModal').classList.add('open');
      try{
        if(!(location.protocol==='https:'||location.hostname==='localhost')){
          alert('Camera requires HTTPS.');
          return;
        }
        camStream = await navigator.mediaDevices.getUserMedia({video:true});
        el('#cam').srcObject = camStream;
        await el('#cam').play();
      }catch(e){alert('Camera not available');}
    });
    el('#closePhoto').addEventListener('click',()=>{
      el('#photoModal').classList.remove('open');
      if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}
    });
  </script>
<script>
(function(){
  // === SMS via Google Apps Script (optional) ===
  // Put your Apps Script Web App URL here (doPost handler)
  const SMS_API_URL = ""; // e.g., https://script.google.com/macros/s/AKfycbx.../exec

  function normalizeUSPhoneToE164(input){
    if (!input) return null;
    const digits = String(input).replace(/[^0-9]/g,'');
    if (digits.length === 10) return '+1' + digits;                 // 8595551234 -> +18595551234
    if (digits.length === 11 && digits.startsWith('1')) return '+' + digits; // 18595551234 -> +18595551234
    if (digits.length === 12 && digits.startsWith('+1')) return digits;      // already +1XXXXXXXXXX
    return null;
  }

  async function sendSms(phoneE164, text){
    if (!SMS_API_URL) return; // not configured yet
    try { await fetch(SMS_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone: phoneE164, text }) }); }
    catch(e){ console.warn('SMS webhook error', e); }
  }

  // Rebind Guest Submit to enforce phone normalization + SMS
  const oldBtn = document.getElementById('g_submit');
  if (oldBtn) {
    const btn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(btn, oldBtn);
    btn.addEventListener('click', async ()=>{
      const childFirst = (document.getElementById('g_child_first')||{}).value?.trim() || '';
      const phoneRaw   = (document.getElementById('g_phone')||{}).value?.trim() || '';
      if (!childFirst) { alert('Child first name is required.'); return; }
      if (!phoneRaw)   { alert('Parent mobile is required.');    return; }
      const phoneE164 = normalizeUSPhoneToE164(phoneRaw);
      if (!phoneE164) { alert('Enter a valid US mobile (10 digits or +1…).'); return; }

      const code = String(Math.floor(100000 + Math.random()*900000));
      try { await sendSms(phoneE164, `Pickup code: ${code} for ${childFirst}`); } catch(e) { console.warn(e); }

      const gm = document.getElementById('guestModal'); if (gm) gm.classList.remove('open');
      ['g_parent_first','g_parent_last','g_child_first','g_child_last','g_allergies','g_phone'].forEach(id=>{ const f=document.getElementById(id); if(f) f.value=''; });
      alert('Guest checked in. Pickup code: ' + code);
    });
  }
})();
</script>
</body>
</html>
